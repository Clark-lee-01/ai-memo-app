# Story 2.5: 노트 수정 및 실시간 저장

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 기존 노트를 수정하고 작성 중에 자동으로 저장되도록,
**so that** 노트 내용을 업데이트하고 실수로 데이터를 잃지 않을 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 수정 버튼을 클릭하면 수정 페이지로 이동한다
2. 수정 페이지에서 기존 노트의 제목과 본문이 미리 채워진다
3. 제목과 본문을 수정할 수 있다
4. 수정 중 자동 저장 기능이 작동한다 (5초마다 또는 타이핑 중단 후 2초)
5. 저장 상태가 시각적으로 표시된다 (저장 중, 저장 완료, 저장 실패)
6. 수정 완료 후 노트 상세 페이지로 돌아간다
7. 취소 버튼을 클릭하면 변경사항을 버리고 상세 페이지로 돌아간다
8. 로딩 상태가 표시된다
9. 유효성 검사가 적용된다 (제목 필수, 본문 선택)
10. 반응형 디자인으로 모든 디바이스에서 편집하기 편하다

## Tasks / Subtasks
- [x] 노트 수정 API 확인 (AC: 1, 6)
  - [x] Server Action `updateNote` 함수 확인 (이미 구현됨)
  - [x] 사용자 권한 확인 로직 검증
  - [x] 에러 처리 확인
- [x] 노트 수정 페이지 UI 구현 (AC: 2, 3, 7, 10)
  - [x] 노트 수정 페이지 컴포넌트 생성 (`app/notes/[noteId]/edit/page.tsx`)
  - [x] 기존 노트 데이터 로딩 및 폼 초기화
  - [x] 제목 및 본문 입력 필드 구현
  - [x] 취소 버튼 구현
  - [x] 반응형 레이아웃 구현
- [x] 실시간 자동 저장 기능 구현 (AC: 4, 5)
  - [x] 자동 저장 훅 구현 (`useAutoSave`)
  - [x] 저장 상태 표시 컴포넌트 구현
  - [x] 디바운싱 로직 구현 (타이핑 중단 후 2초)
  - [x] 주기적 저장 로직 구현 (5초마다)
- [x] 로딩 및 에러 처리 (AC: 8, 9)
  - [x] 로딩 스켈레톤 UI 구현 (`app/notes/[noteId]/edit/loading.tsx`)
  - [x] 유효성 검사 구현
  - [x] 에러 메시지 표시
- [x] 노트 수정 페이지 테스트 작성 (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
  - [x] 노트 수정 페이지 렌더링 테스트
  - [x] 자동 저장 기능 테스트
  - [x] 유효성 검사 테스트
  - [x] 에러 처리 테스트

## Dev Notes

### Previous Story Insights
[Source: Story 2.4]
- 노트 상세 조회 페이지 완료
- 수정 버튼이 `/notes/${noteId}/edit` 페이지로 이동하도록 구현됨
- AlertDialog 컴포넌트 활용
- date-fns 라이브러리로 날짜 포맷팅
- Next.js 15 동적 라우트 패턴 (`await params`)

[Source: Story 2.2]
- Server Actions에서 `updateNote` 함수 이미 구현됨
- 노트 생성 폼 컴포넌트 (`NoteForm`) 재사용 가능
- Zod 스키마 기반 유효성 검사 적용

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM (마이그레이션/쿼리)
- **호스팅:** Vercel (Preview/Prod)

### 데이터 모델
[Source: Story 2.1, architecture.md#2]
```typescript
// notes 테이블 스키마
export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  title: text('title').notNull(),
  content: text('content'),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});
```

### API 명세
[Source: architecture.md#4, Story 2.2]
- **엔드포인트:** PUT `/notes/[noteId]` (Server Action: `updateNote`)
- **인증:** Supabase Auth 세션 기반
- **데이터베이스:** Supabase Postgres (Drizzle ORM)
- **권한:** 사용자 ID 스코프로 자신의 노트만 수정 가능
- **에러 처리:**
  - 노트 없음: "노트를 찾을 수 없습니다"
  - 권한 없음: "로그인이 필요합니다" 또는 접근 거부
  - 유효성 검사 실패: 구체적인 필드별 에러 메시지

### 컴포넌트 명세
- **노트 수정 페이지:** `app/notes/[noteId]/edit/page.tsx`
- **로딩 상태:** `app/notes/[noteId]/edit/loading.tsx`
- **자동 저장 훅:** `lib/hooks/useAutoSave.ts`
- **저장 상태 표시:** `components/notes/save-status.tsx`

### 파일 위치
- 노트 수정 페이지: `app/notes/[noteId]/edit/page.tsx`
- 노트 수정 로딩: `app/notes/[noteId]/edit/loading.tsx`
- 자동 저장 훅: `lib/hooks/useAutoSave.ts`
- 저장 상태 컴포넌트: `components/notes/save-status.tsx`
- 노트 Server Actions: `app/actions/notes.ts` (updateNote 함수 이미 존재)
- 테스트: `__tests__/pages/notes/[noteId]/edit/page.test.tsx`

### 보안 고려사항
[Source: architecture.md#3]
- **인증:** 로그인한 사용자만 노트 수정 가능
- **권한:** 사용자 자신의 노트만 수정 가능 (userId 검증)
- **데이터 검증:** noteId UUID 형식 검증 및 폼 데이터 유효성 검사
- **에러 정보 노출:** 민감한 정보 노출 방지

### 이전 스토리에서의 중요 사항
[Source: Story 1.1-1.7, 2.1-2.4]
- Next.js 15에서는 `params`를 `await`해야 함 (동적 라우트)
- Server Component에서 직접 데이터 fetch 가능
- 클라이언트 컴포넌트는 `'use client'` 지시어 필요
- 에러 처리는 try-catch 또는 Next.js error boundary 활용
- Drizzle ORM 쿼리 패턴: `db.update().set().where()`
- 기존 `NoteForm` 컴포넌트 재사용 가능

### 사용자 경험 고려사항
- **자동 저장:** 사용자가 실수로 데이터를 잃지 않도록 자동 저장
- **저장 상태 표시:** 현재 저장 상태를 명확히 표시
- **반응형 에디터:** 모바일에서도 편집하기 편한 인터페이스
- **키보드 단축키:** Ctrl+S로 수동 저장 가능
- **변경사항 감지:** 저장되지 않은 변경사항이 있을 때 경고
- **빠른 로딩:** 기존 노트 데이터를 빠르게 로드

### Testing

#### 테스트 파일 위치
- 페이지 테스트: `__tests__/pages/notes/[noteId]/edit/page.test.tsx`
- 훅 테스트: `__tests__/hooks/useAutoSave.test.ts`
- 컴포넌트 테스트: `__tests__/components/notes/save-status.test.tsx`
- 액션 테스트: `__tests__/actions/notes.test.ts` (updateNote 테스트 이미 존재)

#### 테스트 표준
[Source: Story 1.1-1.7, 2.1-2.4]
- **프레임워크:** Jest + React Testing Library
- **실행 명령:** `pnpm test`
- **커버리지:** 모든 주요 기능에 대한 단위 테스트 및 통합 테스트 작성

#### 이 스토리의 특정 테스트 요구사항
- 노트 수정 페이지 렌더링 테스트
- 기존 노트 데이터 로딩 테스트
- 자동 저장 기능 테스트 (디바운싱, 주기적 저장)
- 저장 상태 표시 테스트
- 유효성 검사 테스트
- 에러 처리 테스트
- 취소 기능 테스트

### 추가 구현 세부사항

#### 자동 저장 전략
- **디바운싱:** 타이핑 중단 후 2초 대기
- **주기적 저장:** 5초마다 자동 저장
- **수동 저장:** Ctrl+S 키보드 단축키
- **저장 상태:** saving, saved, error 상태 표시

#### UI 레이아웃
```
┌─────────────────────────────────────┐
│ ← 취소        [저장 중...] [저장됨]  │
├─────────────────────────────────────┤
│ [제목 입력 필드]                     │
├─────────────────────────────────────┤
│                                     │
│ [본문 입력 필드]                     │
│ (자동 저장 중...)                    │
│                                     │
└─────────────────────────────────────┘
```

#### 자동 저장 훅 설계
```typescript
interface UseAutoSaveOptions {
  data: any;
  onSave: (data: any) => Promise<void>;
  debounceMs?: number;
  intervalMs?: number;
  enabled?: boolean;
}

interface SaveStatus {
  status: 'idle' | 'saving' | 'saved' | 'error';
  lastSaved?: Date;
  error?: string;
}
```

#### 저장 상태 표시
- **저장 중:** "저장 중..." (스피너)
- **저장 완료:** "저장됨" (체크 아이콘)
- **저장 실패:** "저장 실패" (에러 아이콘)
- **마지막 저장 시간:** "2분 전에 저장됨"

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-14 | 1.0 | 초기 스토리 생성 | Bob (SM) |
| 2025-01-14 | 1.1 | 노트 수정 및 실시간 자동 저장 기능 구현 완료 | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- 노트 수정 및 실시간 자동 저장 기능 구현 완료
- 자동 저장 훅 (useAutoSave) 구현
- 저장 상태 표시 컴포넌트 구현
- 노트 수정 페이지 및 로딩 페이지 구현
- NoteForm 컴포넌트에 자동 저장 기능 추가
- 브라우저 테스트를 통한 모든 기능 검증 완료

### Completion Notes List
- ✅ 노트 수정 페이지 `app/notes/[noteId]/edit/page.tsx` 구현
- ✅ 노트 수정 폼 컴포넌트 `components/notes/note-edit-form.tsx` 구현
- ✅ 자동 저장 훅 `lib/hooks/useAutoSave.ts` 구현 (디바운싱 + 주기적 저장)
- ✅ 저장 상태 표시 컴포넌트 `components/notes/save-status.tsx` 구현
- ✅ 로딩 스켈레톤 `app/notes/[noteId]/edit/loading.tsx` 구현
- ✅ NoteForm 컴포넌트에 수정 모드 및 자동 저장 기능 추가
- ✅ Ctrl+S 키보드 단축키 지원
- ✅ 실시간 유효성 검사 및 에러 처리
- ✅ 변경사항 감지 및 저장 상태 표시
- ✅ 취소 시 변경사항 확인 다이얼로그
- ✅ 반응형 디자인 및 사용자 경험 최적화
- ✅ 테스트 작성 (자동 저장 훅, 저장 상태 컴포넌트, 수정 페이지)
- ✅ 브라우저 테스트를 통한 모든 Acceptance Criteria 검증 완료

### File List
- app/notes/[noteId]/edit/page.tsx (신규)
- app/notes/[noteId]/edit/loading.tsx (신규)
- components/notes/note-edit-form.tsx (신규)
- components/notes/save-status.tsx (신규)
- lib/hooks/useAutoSave.ts (신규)
- components/notes/note-form.tsx (수정 - 자동 저장 기능 추가)
- components/ui/skeleton.tsx (신규 - shadcn/ui 추가)
- __tests__/hooks/useAutoSave.test.ts (신규)
- __tests__/components/notes/save-status.test.tsx (신규)
- __tests__/components/notes/note-edit-form.test.tsx (신규)
- __tests__/pages/notes/[noteId]/edit/page.test.tsx (신규)

## QA Results
*QA 검토 후 기록됩니다*

