# Story 2.6: 노트 삭제 및 복구

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 노트를 삭제하고 실수로 삭제한 노트를 복구할 수 있도록,
**so that** 불필요한 노트를 정리하고 실수로 삭제한 중요한 노트를 되돌릴 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 삭제 버튼을 클릭하면 삭제 확인 다이얼로그가 표시된다
2. 삭제 확인 시 노트가 휴지통으로 이동되고 목록에서 사라진다
3. 삭제된 노트는 30일 후 영구 삭제된다
4. 휴지통 페이지에서 삭제된 노트 목록을 확인할 수 있다
5. 휴지통에서 노트를 복구할 수 있다
6. 휴지통에서 노트를 영구 삭제할 수 있다
7. 휴지통 비우기 기능으로 모든 삭제된 노트를 영구 삭제할 수 있다
8. 삭제된 노트는 검색 결과에 나타나지 않는다
9. 복구된 노트는 원래 위치로 돌아간다
10. 삭제 및 복구 작업에 대한 성공/실패 피드백이 제공된다

## Tasks / Subtasks
- [x] 데이터베이스 스키마 수정 (AC: 3, 4)
  - [x] notes 테이블에 deletedAt, deletedBy 컬럼 추가
  - [x] 휴지통 관련 인덱스 추가
  - [x] 마이그레이션 파일 생성
- [x] 노트 삭제 API 수정 (AC: 1, 2, 3)
  - [x] deleteNote 함수를 소프트 삭제로 변경
  - [x] 삭제 확인 다이얼로그 UI 개선
  - [x] 삭제 시간 기록 로직 추가
- [x] 휴지통 페이지 구현 (AC: 4, 5, 6, 7)
  - [x] 휴지통 페이지 라우트 생성 (`/trash`)
  - [x] 삭제된 노트 목록 조회 API 구현
  - [x] 노트 복구 API 구현
  - [x] 영구 삭제 API 구현
  - [x] 휴지통 비우기 API 구현
- [x] 휴지통 UI 컴포넌트 구현 (AC: 4, 5, 6, 7, 10)
  - [x] 휴지통 페이지 컴포넌트
  - [x] 삭제된 노트 카드 컴포넌트
  - [x] 복구/영구삭제 액션 버튼
  - [x] 휴지통 비우기 다이얼로그
  - [x] 삭제 시간 표시
- [x] 검색 기능 수정 (AC: 8)
  - [x] 삭제된 노트 제외 로직 추가
  - [x] 검색 결과에서 삭제된 노트 필터링
- [x] 자동 정리 작업 구현 (AC: 3)
  - [x] 30일 경과 노트 영구 삭제 크론잡
  - [x] 배치 삭제 API 구현
- [x] 테스트 작성 (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
  - [x] 삭제 기능 테스트
  - [x] 복구 기능 테스트
  - [x] 휴지통 페이지 테스트
  - [x] 영구 삭제 테스트
  - [x] 검색 필터링 테스트

## Dev Notes

### Previous Story Insights
[Source: Story 2.5]
- 노트 수정 및 실시간 자동 저장 기능 완료
- AlertDialog 컴포넌트 활용 경험
- 자동 저장 훅 (useAutoSave) 구현
- 저장 상태 표시 컴포넌트 구현
- Next.js 15 동적 라우트 패턴 (`await params`)

[Source: Story 2.4]
- 노트 상세 조회 페이지 완료
- 삭제 버튼이 이미 구현되어 있음 (하드 삭제)
- AlertDialog 컴포넌트 활용
- date-fns 라이브러리로 날짜 포맷팅

[Source: Story 2.3]
- 노트 목록 조회 및 페이지네이션 완료
- 노트 카드 컴포넌트 구현
- 빈 상태 UI 구현

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM (마이그레이션/쿼리)
- **호스팅:** Vercel (Preview/Prod)

### 데이터 모델 수정
[Source: Story 2.1, architecture.md#2]
```typescript
// notes 테이블 스키마 수정
export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  title: text('title').notNull(),
  content: text('content'),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  deletedAt: timestamp('deleted_at', { withTimezone: true }), // 새로 추가
  deletedBy: uuid('deleted_by').references(() => users.id), // 새로 추가
});
```

### API 명세
[Source: architecture.md#4, Story 2.2]
- **엔드포인트:** 
  - DELETE `/notes/[noteId]` (소프트 삭제)
  - GET `/trash` (휴지통 목록)
  - POST `/trash/[noteId]/restore` (복구)
  - DELETE `/trash/[noteId]` (영구 삭제)
  - DELETE `/trash` (휴지통 비우기)
- **인증:** Supabase Auth 세션 기반
- **데이터베이스:** Supabase Postgres (Drizzle ORM)
- **권한:** 사용자 ID 스코프로 자신의 노트만 관리 가능

### 컴포넌트 명세
- **휴지통 페이지:** `app/trash/page.tsx`
- **삭제된 노트 카드:** `components/trash/trash-note-card.tsx`
- **휴지통 액션:** `components/trash/trash-actions.tsx`
- **휴지통 비우기 다이얼로그:** `components/trash/empty-trash-dialog.tsx`

### 파일 위치
- 휴지통 페이지: `app/trash/page.tsx`
- 휴지통 로딩: `app/trash/loading.tsx`
- 휴지통 컴포넌트: `components/trash/`
- 휴지통 Server Actions: `app/actions/trash.ts`
- 데이터베이스 마이그레이션: `drizzle/migrations/`
- 테스트: `__tests__/pages/trash/`, `__tests__/actions/trash.test.ts`

### 보안 고려사항
[Source: architecture.md#3]
- **인증:** 로그인한 사용자만 휴지통 접근 가능
- **권한:** 사용자 자신의 삭제된 노트만 조회/복구/영구삭제 가능
- **데이터 검증:** noteId UUID 형식 검증
- **에러 정보 노출:** 민감한 정보 노출 방지
- **자동 정리:** 30일 후 자동 영구 삭제로 저장 공간 관리

### 이전 스토리에서의 중요 사항
[Source: Story 1.1-1.7, 2.1-2.5]
- Next.js 15에서는 `params`를 `await`해야 함 (동적 라우트)
- Server Component에서 직접 데이터 fetch 가능
- 클라이언트 컴포넌트는 `'use client'` 지시어 필요
- 에러 처리는 try-catch 또는 Next.js error boundary 활용
- Drizzle ORM 쿼리 패턴: `db.update().set().where()`
- AlertDialog 컴포넌트 활용 경험

### 사용자 경험 고려사항
- **삭제 확인:** 실수로 삭제하는 것을 방지하기 위한 확인 다이얼로그
- **휴지통 UI:** 삭제된 노트를 쉽게 식별할 수 있는 시각적 구분
- **복구 과정:** 간단한 클릭으로 노트 복구 가능
- **자동 정리:** 30일 후 자동 삭제로 저장 공간 관리
- **피드백:** 모든 작업에 대한 명확한 성공/실패 메시지
- **검색 제외:** 삭제된 노트는 검색 결과에서 제외

### Testing

#### 테스트 파일 위치
- 페이지 테스트: `__tests__/pages/trash/page.test.tsx`
- 컴포넌트 테스트: `__tests__/components/trash/`
- 액션 테스트: `__tests__/actions/trash.test.ts`
- 통합 테스트: `__tests__/integration/trash-flow.test.ts`

#### 테스트 표준
[Source: Story 1.1-1.7, 2.1-2.5]
- **프레임워크:** Jest + React Testing Library
- **실행 명령:** `pnpm test`
- **커버리지:** 모든 주요 기능에 대한 단위 테스트 및 통합 테스트 작성

#### 이 스토리의 특정 테스트 요구사항
- 소프트 삭제 기능 테스트
- 휴지통 페이지 렌더링 테스트
- 노트 복구 기능 테스트
- 영구 삭제 기능 테스트
- 휴지통 비우기 기능 테스트
- 검색 필터링 테스트
- 자동 정리 작업 테스트

### 추가 구현 세부사항

#### 소프트 삭제 전략
- **삭제 시:** `deletedAt`에 현재 시간, `deletedBy`에 사용자 ID 기록
- **조회 시:** `deletedAt IS NULL` 조건으로 삭제되지 않은 노트만 조회
- **복구 시:** `deletedAt`과 `deletedBy`를 NULL로 설정
- **영구 삭제:** 실제 데이터베이스에서 레코드 삭제

#### 휴지통 UI 레이아웃
```
┌─────────────────────────────────────┐
│ 휴지통                    [비우기]  │
├─────────────────────────────────────┤
│ [삭제된 노트 카드 1] [복구] [삭제]  │
│ [삭제된 노트 카드 2] [복구] [삭제]  │
│ [삭제된 노트 카드 3] [복구] [삭제]  │
└─────────────────────────────────────┘
```

#### 자동 정리 작업
- **크론잡:** 매일 새벽 2시에 실행
- **조건:** `deletedAt < NOW() - INTERVAL '30 days'`
- **작업:** 해당 노트들을 영구 삭제
- **로깅:** 삭제된 노트 수와 사용자 ID 기록

#### 삭제 확인 다이얼로그 개선
- **기존:** "정말로 이 노트를 삭제하시겠습니까?"
- **개선:** "이 노트를 휴지통으로 이동하시겠습니까? 30일 후 자동으로 영구 삭제됩니다."

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-14 | 1.0 | 초기 스토리 생성 | Bob (SM) |
| 2025-01-14 | 2.0 | 스토리 2.6 구현 완료 | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cursor AI)

### Debug Log References
- 데이터베이스 스키마 수정 및 마이그레이션 성공
- 소프트 삭제 로직 구현 완료
- 휴지통 UI 컴포넌트 구현 완료
- 자동 정리 기능 구현 완료
- 테스트 작성 및 검증 완료

### Completion Notes List
- ✅ 소프트 삭제 시스템 구현: deletedAt, deletedBy 컬럼 추가
- ✅ 휴지통 페이지 구현: /trash 라우트 및 UI 컴포넌트
- ✅ 노트 복구/영구삭제 기능 구현
- ✅ 휴지통 비우기 기능 구현
- ✅ 30일 자동 정리 시스템 구현
- ✅ 검색 필터링에서 삭제된 노트 제외
- ✅ 포괄적인 테스트 커버리지 구현

### File List
**새로 생성된 파일:**
- `app/actions/trash.ts` - 휴지통 Server Actions
- `app/trash/page.tsx` - 휴지통 페이지
- `app/trash/loading.tsx` - 휴지통 로딩 상태
- `app/api/cleanup/route.ts` - 자동 정리 API
- `components/trash/trash-header.tsx` - 휴지통 헤더
- `components/trash/trash-note-card.tsx` - 휴지통 노트 카드
- `components/trash/empty-trash-state.tsx` - 빈 휴지통 상태
- `components/trash/empty-trash-dialog.tsx` - 휴지통 비우기 다이얼로그
- `components/trash/trash-pagination.tsx` - 휴지통 페이지네이션
- `scripts/cleanup-expired-notes.js` - 자동 정리 스크립트
- `__tests__/actions/trash.test.ts` - 휴지통 액션 테스트
- `__tests__/components/trash/trash-note-card.test.tsx` - 노트 카드 테스트
- `__tests__/pages/trash/page.test.tsx` - 휴지통 페이지 테스트

**수정된 파일:**
- `drizzle/schema.ts` - deletedAt, deletedBy 컬럼 추가
- `app/actions/notes.ts` - 소프트 삭제 로직 및 검색 필터링
- `package.json` - 자동 정리 스크립트 추가

## QA Results
*QA 검토 후 기록됩니다*
