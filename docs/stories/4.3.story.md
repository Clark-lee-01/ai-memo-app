# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 노트 내용을 기반으로 자동으로 태그를 생성할 수 있도록,
**so that** 노트를 카테고리별로 쉽게 분류하고 검색할 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 태그 생성 버튼이 표시된다
2. 태그 생성 시 로딩 상태가 표시된다
3. 생성된 태그는 최대 6개까지 관련성 높은 키워드로 구성된다
4. 태그는 노트의 핵심 주제와 내용을 정확히 반영한다
5. 태그 생성 실패 시 적절한 에러 메시지가 표시된다
6. 생성된 태그가 데이터베이스에 저장된다
7. 기존 태그가 있는 경우 덮어쓰기 옵션이 제공된다
8. 생성된 태그가 노트 상세 페이지에 표시된다

## Tasks / Subtasks
- [x] Task 1: 서버 액션 구현 (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] Subtask 1.1: generateTags 서버 액션 구현
  - [x] Subtask 1.2: Gemini API 호출 및 태그 생성 로직
  - [x] Subtask 1.3: 태그 데이터베이스 저장 로직 (note_tags 테이블)
  - [x] Subtask 1.4: 기존 태그 덮어쓰기 로직
  - [x] Subtask 1.5: 에러 처리 및 사용자 피드백
- [x] Task 2: UI 컴포넌트 구현 (AC: 1, 2, 5, 7, 8)
  - [x] Subtask 2.1: 태그 생성 버튼 컴포넌트 생성
  - [x] Subtask 2.2: 로딩 상태 표시 컴포넌트
  - [x] Subtask 2.3: 태그 표시 컴포넌트 (Badge 형태)
  - [x] Subtask 2.4: 에러 메시지 표시 컴포넌트
- [x] Task 3: 노트 상세 페이지 통합 (AC: 1, 2, 5, 7, 8)
  - [x] Subtask 3.1: 노트 상세 페이지에 태그 섹션 추가
  - [x] Subtask 3.2: 태그 생성 버튼 통합
  - [x] Subtask 3.3: 기존 태그 표시 로직
  - [x] Subtask 3.4: 태그 재생성 기능
- [x] Task 4: 테스트 작성 (AC: 1-8)
  - [x] Subtask 4.1: 서버 액션 단위 테스트
  - [x] Subtask 4.2: UI 컴포넌트 테스트
  - [x] Subtask 4.3: 통합 테스트 (API 호출 포함)
  - [x] Subtask 4.4: 에러 시나리오 테스트

## Dev Notes

### Previous Story Insights
- 스토리 4.1에서 Gemini API 클라이언트가 완성되어 generateTags 함수 사용 가능
- 스토리 4.2에서 요약 생성 기능이 완성되어 유사한 패턴으로 태그 생성 구현 가능
- Epic 2에서 노트 관리 시스템이 완성되어 노트 데이터 구조와 CRUD 기능 확정
- Supabase 인증 시스템으로 사용자 스코프 기반 데이터 접근 가능

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#데이터-모델]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#데이터-모델]

### API Specifications
- **generateTags 함수**: lib/ai/gemini.ts에서 제공 [Source: 스토리 4.1 구현]
- **서버 액션**: regenerateAI 함수가 Gemini 호출 후 요약/태그 저장 [Source: architecture.md#서버-액션]
- **토큰 제한**: 8k 토큰으로 제한 [Source: architecture.md#성능-가드레일]
- **서버사이드 호출**: 클라이언트에서 직접 외부 API 호출 금지 [Source: workspace rules]

### Component Specifications
- **태그 생성 버튼**: 노트 상세 페이지에 통합
- **로딩 상태**: 스피너와 함께 "태그 생성 중..." 메시지 표시
- **태그 표시**: Badge 컴포넌트를 사용하여 깔끔하게 표시
- **에러 처리**: 사용자 친화적 에러 메시지와 재시도 옵션

### File Locations
- **서버 액션**: app/actions/notes.ts (수정)
- **UI 컴포넌트**: components/notes/ (새로 생성)
- **노트 상세 페이지**: app/notes/[noteId]/page.tsx (수정)
- **테스트**: __tests__/actions/notes.test.ts, __tests__/components/notes/ (수정/생성)

### Testing Requirements
- **테스트 프레임워크**: Jest 사용 [Source: workspace rules]
- **테스트 위치**: __tests__/ 디렉토리
- **단위 테스트**: 서버 액션, UI 컴포넌트
- **통합 테스트**: 실제 Gemini API 호출 (모킹 포함)
- **에러 테스트**: API 실패, 네트워크 오류 시나리오

### Technical Constraints
- **Next.js App Router**: 서버 액션으로 구현 [Source: workspace rules]
- **Supabase**: 서비스 롤 키는 서버 전용 [Source: architecture.md#보안]
- **pnpm**: 패키지 매니저 사용 [Source: user rules]
- **한국어**: 모든 응답은 한국어로 [Source: user rules]
- **토큰 제한**: 8k 토큰 초과 시 에러 처리 필요
- **shadcn/ui**: Badge 컴포넌트 사용 [Source: workspace rules]

### Testing
- **테스트 파일 위치**: __tests__/actions/, __tests__/components/notes/ 디렉토리
- **테스트 표준**: Jest 프레임워크 사용, 각 함수별 단위 테스트
- **테스트 패턴**: Given-When-Then 패턴 사용
- **모킹**: Gemini API 호출은 모킹하여 테스트
- **통합 테스트**: 실제 API 키로 테스트 (개발 환경에서만)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Anthropic)

### Debug Log References
- UUID 유효성 검사로 인한 테스트 실패 문제 해결
- DB 모킹 설정으로 인한 테스트 오류 해결

### Completion Notes List
- ✅ 서버 액션 구현: generateNoteTags, getNoteTags 함수 완성
- ✅ UI 컴포넌트 구현: TagsSection 컴포넌트 완성
- ✅ 노트 상세 페이지 통합: 태그 섹션 추가 완료
- ✅ 테스트 작성: 컴포넌트 테스트 10개 모두 통과
- ✅ 모든 Acceptance Criteria 충족

### File List
**수정된 파일:**
- `app/actions/notes.ts` - generateNoteTags, getNoteTags 서버 액션 추가
- `app/notes/[noteId]/page.tsx` - 태그 섹션 통합
- `__tests__/actions/notes.test.ts` - 태그 관련 테스트 추가

**새로 생성된 파일:**
- `components/notes/tags-section.tsx` - 태그 섹션 UI 컴포넌트
- `__tests__/components/notes/tags-section.test.tsx` - 컴포넌트 테스트

## QA Results
*QA 에이전트가 검토 후 채워집니다*
