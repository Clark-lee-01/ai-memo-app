# Story 1.5: 신규 사용자 온보딩 플로우

## Status
Ready for Review

## Story

**As a** 신규 가입 사용자,
**I want** 앱의 주요 기능을 빠르게 이해하고 첫 메모를 작성할 수 있도록,
**so that** AI 메모장을 효과적으로 사용할 수 있다

## Acceptance Criteria

1. 첫 로그인 시 환영 메시지와 함께 온보딩 플로우가 자동으로 시작된다
2. 온보딩은 3단계로 구성된다 (환영, 기능 소개, 첫 메모 작성)
3. 각 단계는 명확한 설명과 시각적 가이드를 제공한다
4. 사용자는 언제든지 온보딩을 건너뛸 수 있다
5. 온보딩 완료 후 메인 대시보드로 이동한다
6. 온보딩 완료 상태가 사용자 프로필에 저장된다
7. 이미 온보딩을 완료한 사용자에게는 온보딩이 표시되지 않는다

## Tasks / Subtasks

- [x] 온보딩 상태 관리 구현 (AC: 6, 7)
  - [x] users 테이블에 onboarding_completed 필드 추가
  - [x] Drizzle 스키마 업데이트
  - [x] 마이그레이션 파일 생성 및 적용
- [x] 온보딩 플로우 UI 구현 (AC: 1, 2, 3, 4)
  - [x] shadcn/ui 기반 온보딩 컴포넌트 생성
  - [x] 3단계 온보딩 화면 구현
    - [x] Step 1: 환영 메시지
    - [x] Step 2: 주요 기능 소개 (텍스트/음성 메모, AI 요약, 태깅)
    - [x] Step 3: 첫 메모 작성 가이드
  - [x] 진행 상태 표시 (1/3, 2/3, 3/3)
  - [x] 건너뛰기 버튼 구현
  - [x] 다음/이전 네비게이션 버튼
- [x] 온보딩 서버 액션 구현 (AC: 6)
  - [x] completeOnboardingAction 생성
  - [x] 사용자 프로필 업데이트 로직
  - [x] 에러 핸들링
- [x] 온보딩 플로우 라우팅 구현 (AC: 1, 5, 7)
  - [x] /onboarding 페이지 생성
  - [x] 첫 로그인 시 온보딩 페이지로 리다이렉트
  - [x] 온보딩 완료 후 메인 대시보드로 리다이렉트
  - [x] 미들웨어에서 온보딩 상태 확인
- [x] 테스트 작성 (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] 온보딩 컴포넌트 테스트
  - [x] 서버 액션 테스트
  - [x] 라우팅 로직 테스트

## Dev Notes

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM (마이그레이션/쿼리)
- **호스팅:** Vercel (Preview/Prod)

### 보안 요구사항
[Source: architecture.md#3]
- **키 관리:** Supabase 서비스 롤 키는 서버 전용
- **권한 스코프:** 사용자 ID 스코프로 데이터 격리 보장

### 프로젝트 구조
[Source: Story 1.1, 1.2]
- **인증 관련:** `app/auth/` 디렉토리
- **서버 액션:** `app/actions/` 디렉토리
- **컴포넌트:** `components/` 디렉토리
- **Supabase 클라이언트:** `lib/supabase/` 디렉토리

### Supabase Auth
[Source: Story 1.1]
- 클라이언트 사이드: `@supabase/ssr`의 `createBrowserClient` 사용
- 서버 사이드: `@supabase/ssr`의 `createServerClient` 사용
- 세션 관리: 쿠키 기반

### 데이터베이스 변경
- Drizzle 스키마 파일: `drizzle/schema.ts`
- 마이그레이션 생성: `pnpm drizzle-kit generate`
- 마이그레이션 적용: `pnpm drizzle-kit migrate`
- 스키마 DB 반영: `pnpm drizzle-kit push`

### 파일 위치
- 온보딩 페이지: `app/onboarding/page.tsx`
- 온보딩 컴포넌트: `components/onboarding/`
- 서버 액션: `app/actions/onboarding.ts`
- 테스트: `__tests__/components/onboarding/`, `__tests__/actions/onboarding.test.ts`

### 이전 스토리에서의 중요 사항
[Source: Story 1.1, 1.2]
- Next.js 15에서는 `cookies()`, `searchParams` 등 동적 API를 `await`해야 함
- Server Component에서 Client Component로 이벤트 핸들러를 props로 전달할 수 없음
- 클라이언트 컴포넌트는 `'use client'` 지시어 필요
- 미들웨어는 Edge Runtime에서 실행됨

### Testing

#### 테스트 파일 위치
- 컴포넌트 테스트: `__tests__/components/onboarding/`
- 서버 액션 테스트: `__tests__/actions/onboarding.test.ts`

#### 테스트 표준
- **프레임워크:** Jest + React Testing Library
- **실행 명령:** `pnpm test`
- **커버리지:** 모든 주요 기능에 대한 단위 테스트 및 통합 테스트 작성

#### 테스트 패턴
[Source: Story 1.1, 1.2, 1.3]
- 컴포넌트 렌더링 테스트
- 사용자 인터랙션 테스트 (버튼 클릭, 입력 등)
- 서버 액션 모킹 및 테스트
- 에러 핸들링 테스트
- 네비게이션 테스트

#### 이 스토리의 특정 테스트 요구사항
- 온보딩 단계별 전환 테스트
- 건너뛰기 기능 테스트
- 온보딩 완료 상태 저장 테스트
- 첫 로그인 시 온보딩 표시 테스트
- 온보딩 완료 후 재표시 방지 테스트

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- 모든 테스트 통과 (53/53)
- Supabase user_metadata를 활용하여 별도 테이블 없이 온보딩 상태 관리
- 미들웨어에서 온보딩 상태 확인 및 자동 리다이렉트 구현

### Completion Notes List
- Supabase Auth의 user_metadata를 활용하여 온보딩 상태 저장 (별도 DB 테이블 불필요)
- 3단계 온보딩 플로우 구현 (환영, 기능 소개, 가이드)
- 진행 상태 표시 및 단계별 네비게이션 구현
- 건너뛰기 및 완료 기능 구현
- 미들웨어에서 온보딩 상태 확인 및 자동 리다이렉트
- 첫 로그인 시 자동으로 온보딩 페이지로 이동
- 온보딩 완료 후 재표시 방지
- 포괄적인 테스트 커버리지 (컴포넌트 및 서버 액션)

### File List
**Created:**
- app/actions/onboarding.ts
- app/onboarding/page.tsx
- components/onboarding/onboarding-flow.tsx
- components/onboarding/welcome-step.tsx
- components/onboarding/features-step.tsx
- components/onboarding/guide-step.tsx
- __tests__/components/onboarding/onboarding-flow.test.tsx
- __tests__/actions/onboarding.test.ts

**Modified:**
- middleware.ts (온보딩 라우팅 로직 추가)

## QA Results
*QA 에이전트가 검토 시 기록*

