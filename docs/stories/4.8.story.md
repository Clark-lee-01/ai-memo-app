# Story 4.8: 토큰 사용량 모니터링

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** AI API 사용량을 실시간으로 모니터링하고 제한을 관리할 수 있도록,
**so that** API 비용을 효율적으로 관리하고 서비스 안정성을 유지할 수 있다

## Acceptance Criteria
1. 실시간 토큰 사용량이 대시보드에 표시된다
2. 일일/시간당 사용량 한도를 설정할 수 있다
3. 사용량 한도에 근접할 때 경고 알림이 표시된다
4. 사용량 한도를 초과하면 AI 기능이 제한된다
5. 사용량 통계 및 트렌드를 분석할 수 있다
6. 사용자별 사용량을 개별 관리할 수 있다
7. API 비용 예측 및 최적화 제안을 제공한다
8. 관리자용 사용량 모니터링 대시보드가 제공된다

## Tasks / Subtasks
- [x] Task 1: 실시간 토큰 사용량 표시 (AC: 1, 2)
  - [x] Subtask 1.1: 사용량 대시보드 UI 컴포넌트 생성
  - [x] Subtask 1.2: 실시간 사용량 업데이트 로직 구현
  - [x] Subtask 1.3: 사용량 한도 설정 인터페이스 구축
  - [x] Subtask 1.4: 사용량 차트 및 시각화 구현
- [x] Task 2: 사용량 제한 및 경고 시스템 (AC: 3, 4)
  - [x] Subtask 2.1: 사용량 임계값 설정 기능
  - [x] Subtask 2.2: 경고 알림 시스템 구현
  - [x] Subtask 2.3: 사용량 초과 시 기능 제한 로직
  - [x] Subtask 2.4: 사용량 복구 및 재설정 기능
- [x] Task 3: 사용량 분석 및 통계 (AC: 5, 6)
  - [x] Subtask 3.1: 사용량 통계 데이터 수집
  - [x] Subtask 3.2: 트렌드 분석 및 예측 기능
  - [x] Subtask 3.3: 사용자별 사용량 분석
  - [x] Subtask 3.4: 사용량 리포트 생성 기능
- [x] Task 4: 비용 관리 및 최적화 (AC: 7, 8)
  - [x] Subtask 4.1: API 비용 계산 및 예측
  - [x] Subtask 4.2: 사용량 최적화 제안 시스템
  - [x] Subtask 4.3: 관리자용 모니터링 대시보드
  - [x] Subtask 4.4: 사용량 알림 및 보고서 시스템
- [x] Task 5: 테스트 작성 (AC: 1-8)
  - [x] Subtask 5.1: 사용량 모니터링 테스트
  - [x] Subtask 5.2: 제한 및 경고 시스템 테스트
  - [x] Subtask 5.3: 통계 및 분석 테스트
  - [x] Subtask 5.4: 비용 관리 테스트

## Dev Notes

### Previous Story Insights
- 스토리 4.1에서 Gemini API 클라이언트가 완성되어 기본 토큰 관리 패턴 확정
- 스토리 4.2에서 요약 생성 기능이 완성되어 요약 관련 토큰 사용량 추적 필요
- 스토리 4.3에서 태그 생성 기능이 완성되어 태그 관련 토큰 사용량 추적 필요
- 스토리 4.4에서 AI 상태 관리 훅이 완성되어 상태 기반 모니터링 패턴 확정
- 스토리 4.5에서 재생성 기능이 완성되어 재시도 시 토큰 사용량 관리 필요
- 스토리 4.6에서 편집 기능이 완성되어 수동 편집 시 토큰 사용량 차감 로직 필요
- 스토리 4.7에서 에러 핸들링이 완성되어 토큰 모니터링 시스템 기반 구축

### Token Monitoring Requirements
- **실시간 모니터링**: 현재 사용량, 남은 사용량, 사용률 표시 [Source: 기존 토큰 모니터링 시스템]
- **사용량 제한**: 일일/시간당/요청당 토큰 제한 설정 [Source: API 제한 사항]
- **경고 시스템**: 80%, 90%, 100% 임계값에서 알림 [Source: 비용 관리 best practices]
- **통계 분석**: 사용량 트렌드, 사용자별 분석, 비용 예측 [Source: 모니터링 요구사항]

### UI/UX Specifications
- **대시보드**: 사용량 차트, 제한 설정, 경고 상태 표시 [Source: shadcn/ui 컴포넌트]
- **알림**: 토스트, 배지, 모달을 통한 경고 표시 [Source: 기존 UI 패턴]
- **설정**: 사용량 한도, 경고 임계값, 알림 설정 [Source: 기존 설정 UI 패턴]
- **관리자**: 전체 사용량, 사용자별 분석, 비용 관리 [Source: 관리자 대시보드 요구사항]

### API Specifications
- **토큰 계산**: 입력/출력 토큰 정확한 계산 [Source: Gemini API 문서]
- **사용량 추적**: 실시간 사용량 업데이트 [Source: 기존 토큰 모니터링 시스템]
- **제한 관리**: 동적 제한 설정 및 적용 [Source: API 제한 사항]
- **통계 수집**: 사용량 데이터 수집 및 저장 [Source: 분석 요구사항]

### Component Specifications
- **사용량 대시보드**: TokenUsageDashboard 컴포넌트 [Source: shadcn/ui]
- **사용량 차트**: Chart.js 또는 Recharts 활용 [Source: 차트 라이브러리]
- **제한 설정**: TokenLimitSettings 컴포넌트 [Source: 기존 설정 컴포넌트]
- **경고 알림**: TokenUsageAlert 컴포넌트 [Source: 기존 알림 컴포넌트]

### File Locations
- **대시보드 컴포넌트**: components/dashboard/token-usage-dashboard.tsx (새로 생성)
- **설정 컴포넌트**: components/settings/token-limit-settings.tsx (새로 생성)
- **알림 컴포넌트**: components/ui/token-usage-alert.tsx (새로 생성)
- **통계 API**: app/api/token-usage/route.ts (새로 생성)
- **관리자 대시보드**: app/admin/token-monitoring/page.tsx (새로 생성)
- **테스트**: __tests__/dashboard/, __tests__/api/token-usage/ (새로 생성)

### Testing Requirements
- **테스트 프레임워크**: Jest 사용 [Source: workspace rules]
- **테스트 위치**: __tests__/ 디렉토리
- **단위 테스트**: 토큰 계산, 사용량 추적, 제한 관리
- **통합 테스트**: 대시보드 UI, API 엔드포인트
- **E2E 테스트**: 사용량 모니터링 전체 플로우

### Technical Constraints
- **Next.js App Router**: API 라우트 및 서버 컴포넌트 [Source: workspace rules]
- **React Hooks**: 사용량 상태 관리 [Source: workspace rules]
- **shadcn/ui**: 대시보드 및 차트 컴포넌트 [Source: workspace rules]
- **한국어**: 모든 UI 텍스트는 한국어로 [Source: user rules]
- **접근성**: 스크린 리더 지원을 위한 적절한 ARIA 속성

### Performance Considerations
- **실시간 업데이트**: WebSocket 또는 Server-Sent Events 활용
- **데이터 캐싱**: 사용량 데이터 캐싱으로 성능 최적화
- **차트 렌더링**: 대용량 데이터 처리를 위한 가상화
- **API 최적화**: 사용량 조회 API 성능 최적화

### Security & Privacy
- **사용자 데이터**: 개인별 사용량 데이터 보호
- **관리자 권한**: 관리자만 전체 사용량 조회 가능
- **API 보안**: 토큰 사용량 API 인증 및 권한 검사
- **데이터 암호화**: 민감한 사용량 데이터 암호화

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Anthropic)

### Debug Log References
- 토큰 사용량 모니터링 시스템 구현
- 실시간 대시보드 및 경고 시스템 구축
- 비용 관리 및 최적화 기능 개발
- 포괄적인 테스트 커버리지 확보

### Completion Notes List
- **Task 1 완료**: 실시간 토큰 사용량 표시 기능 구현
  - 사용량 대시보드 UI 컴포넌트 생성 (`components/dashboard/token-usage-dashboard.tsx`)
  - 실시간 사용량 업데이트 로직 구현 (30초마다 자동 새로고침)
  - 사용량 한도 설정 인터페이스 구축 (`components/settings/token-limit-settings.tsx`)
  - 사용량 차트 및 시각화 구현 (Progress 컴포넌트 활용)

- **Task 2 완료**: 사용량 제한 및 경고 시스템 구현
  - 사용량 임계값 설정 기능 (80%, 90%, 100% 임계값)
  - 경고 알림 시스템 구현 (`components/ui/token-usage-alert.tsx`)
  - 사용량 초과 시 기능 제한 로직 (`components/ui/token-limit-guard.tsx`)
  - 사용량 복구 및 재설정 기능 (미들웨어 및 API 엔드포인트)

- **Task 3 완료**: 사용량 분석 및 통계 기능 구현
  - 사용량 통계 데이터 수집 (`components/analytics/token-usage-analytics.tsx`)
  - 트렌드 분석 및 예측 기능 (일일/시간별 트렌드)
  - 사용자별 사용량 분석 (관리자용)
  - 사용량 리포트 생성 기능 (CSV 내보내기)

- **Task 4 완료**: 비용 관리 및 최적화 기능 구현
  - API 비용 계산 및 예측 (`components/cost/token-cost-management.tsx`)
  - 사용량 최적화 제안 시스템 (자동 제안 생성)
  - 관리자용 모니터링 대시보드 (`app/admin/token-monitoring/page.tsx`)
  - 사용량 알림 및 보고서 시스템 (실시간 알림)

- **Task 5 완료**: 포괄적인 테스트 작성
  - 사용량 모니터링 테스트 (`__tests__/components/dashboard/token-usage-dashboard.test.tsx`)
  - 제한 및 경고 시스템 테스트 (`__tests__/components/settings/token-limit-settings.test.tsx`)
  - 통계 및 분석 테스트 (`__tests__/components/analytics/token-usage-analytics.test.tsx`)
  - 비용 관리 테스트 (`__tests__/components/cost/token-cost-management.test.tsx`)
  - API 엔드포인트 테스트 (`__tests__/api/token-usage.test.ts`)
  - 훅 테스트 (`__tests__/hooks/useTokenMonitoring.test.ts`)

### File List
**새로 생성된 파일:**
- `components/dashboard/token-usage-dashboard.tsx` - 토큰 사용량 대시보드
- `components/settings/token-limit-settings.tsx` - 토큰 제한 설정
- `components/ui/token-usage-alert.tsx` - 토큰 사용량 알림
- `components/ui/token-limit-guard.tsx` - 토큰 제한 가드
- `components/ui/progress.tsx` - 진행률 표시 컴포넌트
- `components/ui/skeleton.tsx` - 로딩 스켈레톤 컴포넌트
- `components/analytics/token-usage-analytics.tsx` - 사용량 분석
- `components/cost/token-cost-management.tsx` - 비용 관리
- `app/api/token-usage/route.ts` - 토큰 사용량 API
- `app/api/token-usage/check/route.ts` - 토큰 제한 확인 API
- `app/api/token-usage/analytics/route.ts` - 사용량 분석 API
- `app/api/token-usage/cost/route.ts` - 비용 관리 API
- `app/admin/token-monitoring/page.tsx` - 관리자 대시보드
- `lib/hooks/useTokenMonitoring.ts` - 토큰 모니터링 훅
- `lib/middleware/tokenLimitMiddleware.ts` - 토큰 제한 미들웨어
- `__tests__/components/dashboard/token-usage-dashboard.test.tsx` - 대시보드 테스트
- `__tests__/components/settings/token-limit-settings.test.tsx` - 설정 테스트
- `__tests__/api/token-usage.test.ts` - API 테스트
- `__tests__/hooks/useTokenMonitoring.test.ts` - 훅 테스트

**수정된 파일:**
- `lib/monitoring/tokenMonitor.ts` - 기존 토큰 모니터링 시스템 활용
- `lib/ai/gemini.ts` - 기존 Gemini API 클라이언트와 연동

## QA Results
*QA 에이전트가 검토 후 채워집니다*
