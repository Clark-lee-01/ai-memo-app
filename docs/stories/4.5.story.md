# Story 4.5: AI 결과 재생성 기능

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** AI가 생성한 요약이나 태그를 언제든지 다시 생성할 수 있도록,
**so that** 만족스럽지 않은 결과를 개선하거나 다른 관점의 결과를 얻을 수 있다

## Acceptance Criteria
1. 기존 요약이 있을 때 재생성 버튼이 표시된다
2. 기존 태그가 있을 때 재생성 버튼이 표시된다
3. 재생성 시 기존 결과를 덮어쓸지 확인하는 다이얼로그가 표시된다
4. 재생성 과정에서 로딩 상태가 표시된다
5. 재생성 완료 시 새로운 결과가 즉시 반영된다
6. 재생성 실패 시 적절한 에러 메시지가 표시된다
7. 재생성 중에는 다른 AI 기능이 비활성화된다
8. 재생성 횟수에 제한이 없다

## Tasks / Subtasks
- [x] Task 1: 요약 재생성 기능 개선 (AC: 1, 3, 4, 5, 6, 7, 8)
  - [x] Subtask 1.1: 기존 재생성 로직 검토 및 개선
  - [x] Subtask 1.2: 덮어쓰기 확인 다이얼로그 개선
  - [x] Subtask 1.3: 재생성 상태 관리 개선
  - [x] Subtask 1.4: 에러 처리 및 사용자 피드백 개선
- [x] Task 2: 태그 재생성 기능 개선 (AC: 2, 3, 4, 5, 6, 7, 8)
  - [x] Subtask 2.1: 기존 재생성 로직 검토 및 개선
  - [x] Subtask 2.2: 덮어쓰기 확인 다이얼로그 개선
  - [x] Subtask 2.3: 재생성 상태 관리 개선
  - [x] Subtask 2.4: 에러 처리 및 사용자 피드백 개선
- [x] Task 3: 재생성 UI/UX 개선 (AC: 1, 2, 3, 4, 5, 7)
  - [x] Subtask 3.1: 재생성 버튼 디자인 개선
  - [x] Subtask 3.2: 재생성 확인 다이얼로그 개선
  - [x] Subtask 3.3: 재생성 진행 상태 표시 개선
  - [x] Subtask 3.4: 재생성 완료 피드백 개선
- [x] Task 4: 재생성 로직 통합 (AC: 4, 5, 6, 7, 8)
  - [x] Subtask 4.1: 공통 재생성 훅 생성
  - [x] Subtask 4.2: 재생성 상태 관리 통합
  - [x] Subtask 4.3: 재생성 에러 처리 통합
  - [x] Subtask 4.4: 재생성 로깅 및 모니터링
- [x] Task 5: 테스트 작성 (AC: 1-8)
  - [x] Subtask 5.1: 요약 재생성 기능 테스트
  - [x] Subtask 5.2: 태그 재생성 기능 테스트
  - [x] Subtask 5.3: 재생성 UI/UX 테스트
  - [x] Subtask 5.4: 통합 테스트

## Dev Notes

### Previous Story Insights
- 스토리 4.1에서 Gemini API 클라이언트가 완성되어 API 호출 패턴 확정
- 스토리 4.2에서 요약 생성 기능이 완성되어 재생성 로직 참고 가능
- 스토리 4.3에서 태그 생성 기능이 완성되어 재생성 로직 참고 가능
- 스토리 4.4에서 AI 상태 관리 훅이 완성되어 상태 관리 패턴 확정

### Data Models
- **재생성 상태**: regenerating, success, error, idle [Source: 기존 AI 상태 관리 패턴]
- **재생성 타입**: summary, tags [Source: 요약/태그 생성 기능]
- **재생성 옵션**: overwrite, append [Source: 기존 덮어쓰기 로직]

### API Specifications
- **요약 재생성**: 기존 generateNoteSummary 함수 활용 [Source: app/actions/notes.ts]
- **태그 재생성**: 기존 generateNoteTags 함수 활용 [Source: app/actions/notes.ts]
- **덮어쓰기 옵션**: overwrite 파라미터로 제어 [Source: 기존 API 설계]

### Component Specifications
- **재생성 버튼**: 기존 재생성 버튼 개선 및 통일
- **확인 다이얼로그**: 덮어쓰기 확인을 위한 AlertDialog 컴포넌트
- **진행 상태**: useAIStatus 훅을 활용한 상태 표시
- **에러 처리**: 통합된 에러 처리 및 사용자 피드백

### File Locations
- **공통 훅**: lib/hooks/useRegeneration.ts (새로 생성)
- **요약 섹션**: components/notes/summary-section.tsx (수정)
- **태그 섹션**: components/notes/tags-section.tsx (수정)
- **테스트**: __tests__/hooks/useRegeneration.test.ts, __tests__/components/notes/ (수정/생성)

### Testing Requirements
- **테스트 프레임워크**: Jest 사용 [Source: workspace rules]
- **테스트 위치**: __tests__/ 디렉토리
- **단위 테스트**: 재생성 훅, UI 컴포넌트
- **통합 테스트**: 실제 재생성 시나리오
- **에러 테스트**: 재생성 실패 시나리오

### Technical Constraints
- **Next.js App Router**: 서버 액션으로 구현 [Source: workspace rules]
- **React Hooks**: 커스텀 훅 패턴 사용 [Source: workspace rules]
- **shadcn/ui**: 기존 UI 컴포넌트 활용 [Source: workspace rules]
- **한국어**: 모든 메시지는 한국어로 [Source: user rules]
- **접근성**: 스크린 리더 지원을 위한 적절한 ARIA 속성

### Testing
- **테스트 파일 위치**: __tests__/hooks/, __tests__/components/notes/ 디렉토리
- **테스트 표준**: Jest 프레임워크 사용, 각 함수별 단위 테스트
- **테스트 패턴**: Given-When-Then 패턴 사용
- **모킹**: AI API 호출은 모킹하여 테스트
- **통합 테스트**: 실제 API 키로 테스트 (개발 환경에서만)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (2024-12-19)

### Debug Log References
- 재생성 훅 구현: useRegeneration.ts에서 재생성 로직 통합
- 컴포넌트 개선: SummarySection, TagsSection에서 새로운 재생성 훅 적용
- 테스트 작성: 45개 테스트 케이스로 재생성 기능 검증

### Completion Notes List
- ✅ 공통 재생성 훅(useRegeneration) 구현으로 코드 중복 제거
- ✅ AlertDialog를 사용한 일관된 재생성 확인 다이얼로그 구현
- ✅ 재생성 중 버튼 비활성화 및 로딩 상태 표시 개선
- ✅ 기존 요약/태그가 있을 때만 재생성 버튼 표시
- ✅ 재생성 횟수 제한 없이 언제든지 재생성 가능
- ✅ 통합된 에러 처리 및 사용자 피드백 시스템
- ✅ 45개 테스트 케이스로 모든 기능 검증 완료

### File List
**새로 생성된 파일:**
- `lib/hooks/useRegeneration.ts` - 공통 재생성 로직 훅
- `__tests__/hooks/useRegeneration.test.ts` - 재생성 훅 테스트
- `__tests__/components/notes/summary-section-regeneration.test.tsx` - 개선된 요약 섹션 테스트
- `__tests__/components/notes/tags-section-regeneration.test.tsx` - 개선된 태그 섹션 테스트

**수정된 파일:**
- `components/notes/summary-section.tsx` - 재생성 훅 통합 및 UI 개선
- `components/notes/tags-section.tsx` - 재생성 훅 통합 및 UI 개선

## QA Results
*QA 에이전트가 검토 후 채워집니다*
