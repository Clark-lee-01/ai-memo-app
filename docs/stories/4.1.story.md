# Story 4.1: Gemini API 설정 및 연동

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** Gemini API가 설정되어 AI 기능을 사용할 수 있도록,
**so that** 노트의 자동 요약과 태그 생성 기능을 활용할 수 있다

## Acceptance Criteria
1. Google Gemini API 키가 환경변수로 설정되어 있다
2. Gemini API 클라이언트가 서버사이드에서 초기화된다
3. API 호출을 위한 기본 함수가 구현되어 있다
4. 토큰 제한(8k 토큰)을 관리하는 로직이 포함되어 있다
5. API 에러 처리가 구현되어 있다
6. 개발 환경과 프로덕션 환경에서 모두 동작한다

## Tasks / Subtasks
- [x] Task 1: 패키지 설치 및 환경변수 설정 (AC: 1, 6)
  - [x] Subtask 1.1: @google/genai 패키지 설치 (pnpm add @google/genai)
  - [x] Subtask 1.2: .env.local에 GEMINI_API_KEY 추가
  - [x] Subtask 1.3: .env.example에 GEMINI_API_KEY 예시 추가
  - [x] Subtask 1.4: Vercel 환경변수 설정 가이드 문서화
- [x] Task 2: Gemini API 클라이언트 구현 (AC: 2, 3)
  - [x] Subtask 2.1: lib/ai/gemini.ts 파일 생성
  - [x] Subtask 2.2: GoogleGenAI 클라이언트 초기화 함수 구현
  - [x] Subtask 2.3: generateContent 함수 구현 (gemini-2.5-flash 모델 사용)
  - [x] Subtask 2.4: thinkingBudget: 0 설정으로 응답 최적화
- [x] Task 3: 토큰 제한 관리 구현 (AC: 4)
  - [x] Subtask 3.1: 텍스트 길이 검증 함수 구현
  - [x] Subtask 3.2: 8k 토큰 제한 체크 로직 추가
  - [x] Subtask 3.3: 토큰 초과 시 에러 처리
- [x] Task 4: 에러 처리 구현 (AC: 5)
  - [x] Subtask 4.1: API 에러 타입 정의
  - [x] Subtask 4.2: 재시도 로직 구현
  - [x] Subtask 4.3: 사용자 친화적 에러 메시지 생성
- [x] Task 5: 테스트 작성 (AC: 1-6)
  - [x] Subtask 5.1: Gemini API 클라이언트 단위 테스트
  - [x] Subtask 5.2: 토큰 제한 검증 테스트
  - [x] Subtask 5.3: 에러 처리 테스트
  - [x] Subtask 5.4: 통합 테스트 (실제 API 호출)

## Dev Notes

### Previous Story Insights
- Epic 2에서 노트 관리 시스템이 완성되어 있어 노트 데이터 구조가 확정됨
- Supabase 인증 시스템이 구축되어 있어 사용자 스코프 기반 API 호출 가능

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#데이터-모델]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#데이터-모델]

### API Specifications
- **Google Gemini API**: 요약/태깅을 위한 AI 모델 [Source: architecture.md#기술-스택]
- **패키지**: @google/genai 사용 (Google 공식 Node.js SDK)
- **모델**: gemini-2.5-flash 사용 (빠른 응답과 비용 효율성)
- **설정**: thinkingBudget: 0으로 '생각' 기능 비활성화하여 응답 최적화
- **토큰 제한**: 8k 토큰으로 제한 [Source: architecture.md#성능-가드레일]
- **서버사이드 호출**: 클라이언트에서 직접 외부 API 호출 금지 [Source: workspace rules]

### Implementation Example
```typescript
// lib/ai/gemini.ts 예시
import { GoogleGenAI } from '@google/genai';

const genAI = new GoogleGenAI({
  apiKey: process.env.GEMINI_API_KEY!,
});

export async function generateContent(prompt: string) {
  const model = genAI.getGenerativeModel({ 
    model: 'gemini-2.5-flash',
    generationConfig: {
      thinkingBudget: 0, // 응답 최적화
    }
  });
  
  const result = await model.generateContent(prompt);
  return result.response.text();
}
```

### Component Specifications
- **서버 액션**: `regenerateAI` 함수가 Gemini 호출 후 요약/태그 저장 [Source: architecture.md#서버-액션]
- **에러 처리**: 사용자 친화적 에러 메시지와 재시도 로직 필요

### File Locations
- **API 클라이언트**: `lib/ai/gemini.ts` (새로 생성)
- **환경변수**: `.env.local`, `.env.example` (수정)
- **패키지 의존성**: `package.json` (pnpm add @google/genai로 추가)
- **테스트**: `__tests__/lib/ai/gemini.test.ts` (새로 생성)

### Testing Requirements
- **테스트 프레임워크**: Jest 사용 [Source: workspace rules]
- **테스트 위치**: `__tests__/` 디렉토리
- **단위 테스트**: API 클라이언트 함수들
- **통합 테스트**: 실제 Gemini API 호출 (모킹 포함)
- **에러 테스트**: API 실패 시나리오

### Technical Constraints
- **Next.js App Router**: 서버 액션으로 구현 [Source: workspace rules]
- **Supabase**: 서비스 롤 키는 서버 전용 [Source: architecture.md#보안]
- **pnpm**: 패키지 매니저 사용 [Source: user rules]
- **@google/genai**: Google 공식 Node.js SDK 사용
- **gemini-2.5-flash**: 빠른 응답을 위한 모델 선택
- **thinkingBudget: 0**: 응답 최적화를 위한 설정
- **한국어**: 모든 응답은 한국어로 [Source: user rules]

### Testing
- **테스트 파일 위치**: `__tests__/lib/ai/` 디렉토리
- **테스트 표준**: Jest 프레임워크 사용, 각 함수별 단위 테스트
- **테스트 패턴**: Given-When-Then 패턴 사용
- **모킹**: Gemini API 호출은 모킹하여 테스트
- **통합 테스트**: 실제 API 키로 테스트 (개발 환경에서만)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |
| 2024-12-19 | 1.1 | @google/genai 패키지 정보 추가 및 구현 예시 포함 | Bob (SM) |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 채워집니다*

### Agent Model Used
Claude 3.5 Sonnet (Anthropic)

### Debug Log References
- Gemini API 클라이언트 테스트에서 모킹 이슈 해결
- 재시도 로직으로 인한 테스트 실패 문제 해결

### Completion Notes List
- @google/genai 패키지 v1.24.0 설치 완료
- 환경변수 설정 (.env.local, .env.example) 완료
- Vercel 배포 가이드 README.md에 추가
- lib/ai/gemini.ts 파일 생성 및 구현 완료
- 토큰 제한 관리 (8k 토큰) 구현 완료
- 에러 처리 및 재시도 로직 구현 완료
- Jest 기반 테스트 17개 모두 통과
- 모든 Acceptance Criteria 충족

### File List
**생성된 파일:**
- lib/ai/gemini.ts - Gemini API 클라이언트 구현
- __tests__/lib/ai/gemini.test.ts - API 클라이언트 테스트

**수정된 파일:**
- .env.local - GEMINI_API_KEY 환경변수 추가
- .env.example - 환경변수 예시 파일 생성
- README.md - Vercel 환경변수 설정 가이드 추가
- package.json - @google/genai 의존성 추가

## QA Results
*QA 에이전트가 검토 후 채워집니다*
